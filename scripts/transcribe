#!/usr/bin/env python3
"""
transcribe - Speech-to-text transcription using onnx-asr with Parakeet TDT

A wrapper around onnx-asr using NVIDIA's Parakeet TDT 0.6B V3 model.
Supports 25 European languages with automatic language detection.
Supports: mp3, mp4, wav, m4a, flac, ogg, webm (via pydub/ffmpeg conversion)

Usage: transcribe <audio_file> [options]

Options:
  -o, --output FILE    Output file path (default: stdout)
  -h, --help           Show this help message

Examples:
  transcribe recording.mp3                    # Output to stdout
  transcribe video.mp4 -o transcript.txt      # Save to file
  transcribe meeting.m4a 2>/dev/null          # Suppress progress messages
"""

import argparse
import os
import sys
import tempfile
from pathlib import Path

# Audio formats that need conversion (non-WAV)
CONVERTIBLE_FORMATS = {'.mp3', '.mp4', '.m4a', '.flac', '.ogg', '.webm'}


def convert_to_wav(input_path: Path) -> tuple:
    """
    Convert audio file to WAV if needed.
    onnx-asr only reads WAV files but handles resampling internally.
    Returns (wav_path, is_temporary).
    """
    suffix = input_path.suffix.lower()

    # WAV files can be used directly - onnx-asr handles resampling
    if suffix == '.wav':
        return input_path, False

    if suffix not in CONVERTIBLE_FORMATS:
        print(f"Error: Unsupported audio format '{suffix}'", file=sys.stderr)
        print(f"Supported formats: wav, {', '.join(sorted(CONVERTIBLE_FORMATS))}",
              file=sys.stderr)
        sys.exit(1)

    try:
        from pydub import AudioSegment
    except ImportError:
        print("Error: pydub not installed. Re-run install-llm-tools.sh",
              file=sys.stderr)
        sys.exit(1)

    print(f"Converting {input_path.name} to WAV...", file=sys.stderr)

    # Load audio file
    try:
        if suffix == '.mp3':
            audio = AudioSegment.from_mp3(str(input_path))
        elif suffix in {'.mp4', '.m4a'}:
            audio = AudioSegment.from_file(str(input_path), 'mp4')
        elif suffix == '.flac':
            audio = AudioSegment.from_file(str(input_path), 'flac')
        elif suffix == '.ogg':
            audio = AudioSegment.from_ogg(str(input_path))
        elif suffix == '.webm':
            audio = AudioSegment.from_file(str(input_path), 'webm')
        else:
            audio = AudioSegment.from_file(str(input_path))
    except Exception as e:
        print(f"Error: Failed to load audio file: {e}", file=sys.stderr)
        print("Make sure ffmpeg is installed: sudo apt install ffmpeg", file=sys.stderr)
        sys.exit(1)

    # Export to temporary WAV file (onnx-asr handles resampling internally)
    temp_file = tempfile.NamedTemporaryFile(suffix='.wav', delete=False)
    audio.export(temp_file.name, format='wav')

    return Path(temp_file.name), True


def transcribe(audio_path: Path) -> str:
    """Transcribe audio file using onnx-asr with Parakeet model."""
    try:
        import onnx_asr
    except ImportError:
        print("Error: onnx-asr not installed. Re-run install-llm-tools.sh",
              file=sys.stderr)
        sys.exit(1)

    # Suppress HuggingFace progress bars
    os.environ["HF_HUB_DISABLE_PROGRESS_BARS"] = "1"

    print("Loading Parakeet TDT model...", file=sys.stderr)
    try:
        model = onnx_asr.load_model("nemo-parakeet-tdt-0.6b-v3")
    except Exception as e:
        print(f"Error: Failed to load model: {e}", file=sys.stderr)
        sys.exit(1)

    print(f"Transcribing {audio_path.name}...", file=sys.stderr)
    try:
        result = model.recognize(str(audio_path))
    except Exception as e:
        print(f"Error: Transcription failed: {e}", file=sys.stderr)
        sys.exit(1)

    return result.strip() if result else ""


def main():
    parser = argparse.ArgumentParser(
        description='Speech-to-text transcription using Parakeet TDT model',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Supported Languages (25 European, auto-detected):
  Bulgarian, Croatian, Czech, Danish, Dutch, English, Estonian, Finnish,
  French, German, Greek, Hungarian, Italian, Latvian, Lithuanian, Maltese,
  Polish, Portuguese, Romanian, Slovak, Slovenian, Spanish, Swedish,
  Russian, Ukrainian

Examples:
  transcribe recording.mp3                    # Output to stdout
  transcribe video.mp4 -o transcript.txt      # Save to file
  transcribe meeting.m4a 2>/dev/null          # Suppress progress messages
"""
    )

    parser.add_argument('audio_file', type=Path,
                        help='Audio file to transcribe')
    parser.add_argument('-o', '--output', type=Path, default=None,
                        help='Output file (default: stdout)')

    args = parser.parse_args()

    # Validate input file
    if not args.audio_file.exists():
        print(f"Error: File not found: {args.audio_file}", file=sys.stderr)
        sys.exit(1)

    # Convert to WAV if needed
    wav_path, is_temp = convert_to_wav(args.audio_file)

    try:
        # Transcribe
        result = transcribe(wav_path)

        # Output result
        if args.output:
            args.output.write_text(result)
            print(f"Transcript saved to: {args.output}", file=sys.stderr)
        else:
            print(result)
    finally:
        # Clean up temporary file
        if is_temp and wav_path.exists():
            wav_path.unlink()


if __name__ == '__main__':
    main()
