<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- JavaScript assets loaded from ~/.local/share/llm-guiassistant/js/ -->
    <!-- Note: $HOME is expanded at runtime by popup.py when loading template -->
    <script src="file://$HOME/.local/share/llm-guiassistant/js/marked.min.js"></script>
    <script src="file://$HOME/.local/share/llm-guiassistant/js/highlight.min.js"></script>
    <style>
        /* Light theme (default) */
        :root {
            --bg-color: #ffffff;
            --text-color: #1a1a1a;
            --code-bg: #f5f5f5;
            --border-color: #e0e0e0;
            --user-bg: #e3f2fd;
            --assistant-bg: #fafafa;
            --button-bg: #e8e8e8;
            --button-hover: #d0d0d0;
            --tool-bg: #fff3e0;
            --error-bg: #ffebee;
        }

        /* Dark theme - WebKit2GTK respects system preference */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1e1e1e;
                --text-color: #e0e0e0;
                --code-bg: #2d2d2d;
                --border-color: #444444;
                --user-bg: #1e3a5f;
                --assistant-bg: #252525;
                --button-bg: #3d3d3d;
                --button-hover: #4d4d4d;
                --tool-bg: #3e2723;
                --error-bg: #4a1c1c;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 8px;
        }

        #conversation {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            max-width: 100%;
            word-wrap: break-word;
        }

        .user {
            background: var(--user-bg);
            margin-left: 20%;
        }

        .assistant {
            background: var(--assistant-bg);
            margin-right: 10%;
        }

        .tool-status {
            background: var(--tool-bg);
            font-size: 0.9em;
            padding: 8px 12px;
            border-radius: 4px;
            font-style: italic;
        }

        .error {
            background: var(--error-bg);
            border-left: 3px solid #f44336;
        }

        /* Empty state styling */
        .empty-state {
            text-align: center;
            color: var(--text-color);
            opacity: 0.6;
            padding: 48px 24px;
        }

        .empty-state h2 {
            font-size: 1.2em;
            margin-bottom: 8px;
            font-weight: normal;
        }

        .empty-state p {
            font-size: 0.9em;
        }

        /* Markdown content styling */
        .message h1, .message h2, .message h3 {
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .message p {
            margin-bottom: 8px;
        }

        .message ul, .message ol {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .message a {
            color: #1976d2;
        }

        @media (prefers-color-scheme: dark) {
            .message a {
                color: #64b5f6;
            }
        }

        /* Code blocks */
        pre {
            background: var(--code-bg);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
            position: relative;
        }

        pre code {
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        code {
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            background: var(--code-bg);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre code {
            background: transparent;
            padding: 0;
        }

        /* Copy button on code blocks */
        .code-wrapper {
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--button-bg);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .code-wrapper:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: var(--button-hover);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: var(--button-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: var(--button-hover);
        }

        /* Images */
        .message img {
            max-width: 100%;
            border-radius: 4px;
            margin: 8px 0;
        }

        /* Tables */
        .message table {
            border-collapse: collapse;
            margin: 8px 0;
            width: 100%;
        }

        .message th, .message td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        .message th {
            background: var(--code-bg);
        }
    </style>
</head>
<body>
    <div id="conversation">
        <!-- Empty state shown when no messages -->
        <div class="empty-state" id="empty-state">
            <h2>How can I help you today?</h2>
            <p>Type a question below, or use quick actions above.</p>
        </div>
    </div>

    <script>
        // Check if required libraries loaded
        if (typeof marked === 'undefined' || typeof hljs === 'undefined') {
            document.body.innerHTML = '<div style="padding: 20px; color: #c00;">' +
                '<h3>JavaScript assets failed to load</h3>' +
                '<p>Missing: ' +
                (typeof marked === 'undefined' ? 'marked.js ' : '') +
                (typeof hljs === 'undefined' ? 'highlight.js' : '') +
                '</p>' +
                '<p>Expected location: ~/.local/share/llm-guiassistant/js/</p>' +
                '<p>Run: <code>./install-llm-tools.sh</code> to download assets.</p>' +
                '</div>';
            throw new Error('Required JavaScript libraries not loaded');
        }

        // Configure marked for safe rendering
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (e) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // Track current streaming message
        let currentMessageId = null;

        function appendMessage(role, content, id) {
            // Hide empty state on first message
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const conversation = document.getElementById('conversation');
            let container;

            // For streaming: update existing container if same ID
            if (id && id === currentMessageId) {
                container = document.getElementById('current-message');
            }

            if (!container) {
                container = document.createElement('div');
                container.id = 'current-message';
                container.className = 'message ' + role;
                conversation.appendChild(container);
                currentMessageId = id;
            }

            // Parse markdown and update content
            container.innerHTML = marked.parse(content);

            // Add copy buttons to code blocks
            container.querySelectorAll('pre').forEach(pre => {
                if (!pre.parentElement.classList.contains('code-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-wrapper';
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = function() {
                        const code = pre.querySelector('code') || pre;
                        navigator.clipboard.writeText(code.textContent);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                    };
                    wrapper.appendChild(copyBtn);
                }
            });

            // Run syntax highlighting
            container.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });

            // Auto-scroll to bottom
            window.scrollTo(0, document.body.scrollHeight);
        }

        function finalizeMessage() {
            // Remove the 'current-message' id when streaming completes
            const current = document.getElementById('current-message');
            if (current) {
                current.removeAttribute('id');
            }
            currentMessageId = null;
        }

        function addToolStatus(message) {
            const conversation = document.getElementById('conversation');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'message tool-status';
            statusDiv.textContent = message;
            conversation.appendChild(statusDiv);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function addError(message) {
            const conversation = document.getElementById('conversation');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error';
            errorDiv.textContent = message;
            conversation.appendChild(errorDiv);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function clearConversation() {
            const conversation = document.getElementById('conversation');
            conversation.innerHTML = `
                <div class="empty-state" id="empty-state">
                    <h2>How can I help you today?</h2>
                    <p>Type a question below, or use quick actions above.</p>
                </div>
            `;
            currentMessageId = null;
        }

        // Expose functions to Python via webkit message handler
        // Python calls these via webview.run_javascript()
    </script>
</body>
</html>
