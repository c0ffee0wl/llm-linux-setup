{
  "$defs": {
    "CaptureMode": {
      "description": "Output capture mode for shell commands.",
      "enum": [
        "memory",
        "file",
        "none"
      ],
      "title": "CaptureMode",
      "type": "string"
    },
    "CaptureStderrMode": {
      "description": "How to handle stderr for shell commands.",
      "enum": [
        "merge",
        "separate",
        "discard"
      ],
      "title": "CaptureStderrMode",
      "type": "string"
    },
    "GuardrailsConfig": {
      "description": "LLM Guard-based guardrails configuration.\n\nSupports 12 input scanners and 17 output scanners from llm-guard.\nCan be specified at workflow level (defaults for all steps) or\nstep level (overrides workflow defaults).\n\nInput Scanners: anonymize, prompt_injection, secrets, invisible_text,\n    token_limit, ban_topics, ban_substrings, ban_code, code, gibberish,\n    language, regex\n\nOutput Scanners: deanonymize, sensitive, no_refusal, factual_consistency,\n    relevance, json, malicious_urls, url_reachability, language_same,\n    language, reading_time, gibberish, ban_topics, ban_substrings,\n    ban_code, code, regex\n\nExample:\n    guardrails:\n      input:\n        prompt_injection: { threshold: 0.92 }\n        secrets: { redact: true }\n      output:\n        sensitive: { redact: true }\n      on_fail: abort",
      "properties": {
        "input": {
          "anyOf": [
            {
              "additionalProperties": {
                "anyOf": [
                  {
                    "additionalProperties": true,
                    "type": "object"
                  },
                  {
                    "type": "null"
                  }
                ]
              },
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Input scanners applied before step execution",
          "title": "Input"
        },
        "output": {
          "anyOf": [
            {
              "additionalProperties": {
                "anyOf": [
                  {
                    "additionalProperties": true,
                    "type": "object"
                  },
                  {
                    "type": "null"
                  }
                ]
              },
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Output scanners applied after step execution",
          "title": "Output"
        },
        "on_fail": {
          "anyOf": [
            {
              "enum": [
                "abort",
                "retry",
                "continue"
              ],
              "type": "string"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Action on failure: abort, retry, continue, or step_id to route to",
          "title": "On Fail"
        },
        "max_retries": {
          "anyOf": [
            {
              "maximum": 5,
              "minimum": 1,
              "type": "integer"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Max retries when on_fail=retry (default: 2)",
          "title": "Max Retries"
        }
      },
      "title": "GuardrailsConfig",
      "type": "object"
    },
    "InputDefinition": {
      "description": "Definition for a workflow input parameter.",
      "properties": {
        "description": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Description"
        },
        "type": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": "string",
          "description": "Input type: string, number, boolean, array, object",
          "title": "Type"
        },
        "default": {
          "anyOf": [
            {},
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Default"
        },
        "required": {
          "default": true,
          "description": "Whether this input is required",
          "title": "Required",
          "type": "boolean"
        },
        "enum": {
          "anyOf": [
            {
              "items": {},
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Allowed values (if restricted)",
          "title": "Enum"
        },
        "pattern": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Regex pattern for validation (strings only)",
          "title": "Pattern"
        },
        "secret": {
          "default": false,
          "description": "Whether this input contains sensitive data",
          "title": "Secret",
          "type": "boolean"
        }
      },
      "title": "InputDefinition",
      "type": "object"
    },
    "JobDefinition": {
      "description": "Definition for a workflow job.",
      "properties": {
        "name": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Name"
        },
        "steps": {
          "items": {
            "$ref": "#/$defs/StepDefinition"
          },
          "title": "Steps",
          "type": "array"
        },
        "finally": {
          "anyOf": [
            {
              "items": {
                "$ref": "#/$defs/StepDefinition"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Cleanup steps (always run)",
          "title": "Finally"
        }
      },
      "required": [
        "steps"
      ],
      "title": "JobDefinition",
      "type": "object"
    },
    "LLMActionDefaultsConfig": {
      "description": "Per-action-type LLM defaults.\n\nUsed within LLMDefaultsConfig to specify defaults for specific\naction types (extract, decide, generate, instruct).",
      "properties": {
        "model": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Model override for this action type",
          "title": "Model"
        },
        "temperature": {
          "anyOf": [
            {
              "maximum": 2,
              "minimum": 0,
              "type": "number"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Temperature override for this action type",
          "title": "Temperature"
        },
        "max_tokens": {
          "anyOf": [
            {
              "minimum": 1,
              "type": "integer"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Max tokens override for this action type",
          "title": "Max Tokens"
        }
      },
      "title": "LLMActionDefaultsConfig",
      "type": "object"
    },
    "LLMDefaultsConfig": {
      "description": "Workflow-level LLM configuration.\n\nProvides centralized defaults for all LLM actions. Step-level\nconfiguration in `with:` always takes precedence.\n\nExample:\n    llm:\n      model: gpt-4\n      temperature: 0.7\n      max_tokens: 2000\n      extract:\n        temperature: 0.3    # Lower for structured output\n      decide:\n        temperature: 0.0    # Deterministic",
      "properties": {
        "model": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Default model for all LLM actions",
          "title": "Model"
        },
        "temperature": {
          "anyOf": [
            {
              "maximum": 2,
              "minimum": 0,
              "type": "number"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Default temperature for all LLM actions",
          "title": "Temperature"
        },
        "max_tokens": {
          "anyOf": [
            {
              "minimum": 1,
              "type": "integer"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Default max tokens for all LLM actions",
          "title": "Max Tokens"
        },
        "extract": {
          "anyOf": [
            {
              "$ref": "#/$defs/LLMActionDefaultsConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Defaults for llm/extract actions (default temp: 0.3)"
        },
        "decide": {
          "anyOf": [
            {
              "$ref": "#/$defs/LLMActionDefaultsConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Defaults for llm/decide actions (default temp: 0.0)"
        },
        "generate": {
          "anyOf": [
            {
              "$ref": "#/$defs/LLMActionDefaultsConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Defaults for llm/generate actions (default temp: 0.7)"
        },
        "instruct": {
          "anyOf": [
            {
              "$ref": "#/$defs/LLMActionDefaultsConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Defaults for llm/instruct actions (default temp: 0.7)"
        }
      },
      "title": "LLMDefaultsConfig",
      "type": "object"
    },
    "ResultStorageMode": {
      "description": "How to store loop results.",
      "enum": [
        "memory",
        "file",
        "none"
      ],
      "title": "ResultStorageMode",
      "type": "string"
    },
    "RetryConfig": {
      "description": "Configuration for step retry behavior.\n\nExample:\n    retry:\n      max_attempts: 3\n      delay: 2.0\n      backoff: 2.0\n      max_delay: 60.0\n      retry_on:\n        - TimeoutError\n        - ConnectionError",
      "properties": {
        "max_attempts": {
          "default": 3,
          "maximum": 10,
          "minimum": 1,
          "title": "Max Attempts",
          "type": "integer"
        },
        "delay": {
          "default": 1.0,
          "description": "Initial delay between retries in seconds",
          "minimum": 0,
          "title": "Delay",
          "type": "number"
        },
        "backoff": {
          "default": 2.0,
          "description": "Exponential backoff multiplier",
          "minimum": 1.0,
          "title": "Backoff",
          "type": "number"
        },
        "max_delay": {
          "default": 60.0,
          "description": "Maximum delay between retries",
          "minimum": 0,
          "title": "Max Delay",
          "type": "number"
        },
        "jitter": {
          "default": true,
          "description": "Add randomness to backoff (0.5-1.5x) to prevent thundering herd",
          "title": "Jitter",
          "type": "boolean"
        },
        "retry_on": {
          "anyOf": [
            {
              "items": {
                "type": "string"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Error types to retry on (None = default network errors)",
          "title": "Retry On"
        }
      },
      "title": "RetryConfig",
      "type": "object"
    },
    "ShellSafetyMode": {
      "description": "Shell safety enforcement mode.",
      "enum": [
        "strict",
        "auto_quote"
      ],
      "title": "ShellSafetyMode",
      "type": "string"
    },
    "StepDefinition": {
      "description": "Definition for a single workflow step.",
      "properties": {
        "name": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Human-readable step name",
          "title": "Name"
        },
        "id": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Step ID for referencing outputs",
          "title": "Id"
        },
        "run": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "items": {
                "type": "string"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Shell command (string or array)",
          "title": "Run"
        },
        "uses": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Action type (e.g., 'llm/extract', 'http/request')",
          "title": "Uses"
        },
        "with": {
          "anyOf": [
            {
              "additionalProperties": true,
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Action-specific configuration",
          "title": "With"
        },
        "if": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Condition expression (step skipped if false)",
          "title": "If"
        },
        "loop": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Expression returning list to iterate over",
          "title": "Loop"
        },
        "break_if": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Condition to break out of loop early",
          "title": "Break If"
        },
        "max_iterations": {
          "default": 10000,
          "description": "Maximum loop iterations (safety limit)",
          "minimum": 1,
          "title": "Max Iterations",
          "type": "integer"
        },
        "max_results": {
          "default": 100,
          "description": "Maximum results to keep in state (sliding window)",
          "minimum": 0,
          "title": "Max Results",
          "type": "integer"
        },
        "max_errors": {
          "default": 50,
          "description": "Maximum errors to accumulate before failing loop",
          "minimum": 0,
          "title": "Max Errors",
          "type": "integer"
        },
        "continue_on_error": {
          "default": false,
          "description": "Continue loop even if iteration fails",
          "title": "Continue On Error",
          "type": "boolean"
        },
        "aggregate_results": {
          "default": true,
          "description": "Whether to store iteration results",
          "title": "Aggregate Results",
          "type": "boolean"
        },
        "result_storage": {
          "$ref": "#/$defs/ResultStorageMode",
          "default": "memory",
          "description": "Where to store loop results"
        },
        "interactive": {
          "default": false,
          "description": "Run command interactively (no capture)",
          "title": "Interactive",
          "type": "boolean"
        },
        "capture_mode": {
          "$ref": "#/$defs/CaptureMode",
          "default": "memory",
          "description": "How to capture command output"
        },
        "capture_stderr": {
          "$ref": "#/$defs/CaptureStderrMode",
          "default": "separate",
          "description": "How to handle stderr: merge into stdout, keep separate, or discard"
        },
        "timeout": {
          "default": 300,
          "description": "Timeout in seconds (default: 5 minutes)",
          "maximum": 86400,
          "minimum": 1,
          "title": "Timeout",
          "type": "integer"
        },
        "on_failure": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Step ID to jump to on failure",
          "title": "On Failure"
        },
        "resume_from": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Where to continue after error handler",
          "title": "Resume From"
        },
        "retry": {
          "anyOf": [
            {
              "$ref": "#/$defs/RetryConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "guardrails": {
          "anyOf": [
            {
              "$ref": "#/$defs/GuardrailsConfig"
            },
            {
              "const": false,
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Step guardrails (merges with workflow defaults, or False to disable)",
          "title": "Guardrails"
        },
        "idempotent": {
          "default": true,
          "description": "Whether step is safe to re-run on resume",
          "title": "Idempotent",
          "type": "boolean"
        }
      },
      "title": "StepDefinition",
      "type": "object"
    }
  },
  "description": "Root workflow definition model.",
  "properties": {
    "name": {
      "description": "Workflow name",
      "title": "Name",
      "type": "string"
    },
    "description": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "title": "Description"
    },
    "version": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Workflow version (semver recommended, e.g., '1.0.0')",
      "title": "Version"
    },
    "author": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Workflow author or maintainer",
      "title": "Author"
    },
    "schema_version": {
      "default": "1.0",
      "description": "Schema version for compatibility",
      "title": "Schema Version",
      "type": "string"
    },
    "inputs": {
      "anyOf": [
        {
          "additionalProperties": {
            "anyOf": [
              {
                "$ref": "#/$defs/InputDefinition"
              },
              {}
            ]
          },
          "type": "object"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Input parameter definitions",
      "title": "Inputs"
    },
    "env": {
      "anyOf": [
        {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Environment variables",
      "title": "Env"
    },
    "jobs": {
      "additionalProperties": {
        "$ref": "#/$defs/JobDefinition"
      },
      "description": "Job definitions (usually just 'main')",
      "title": "Jobs",
      "type": "object"
    },
    "finally": {
      "anyOf": [
        {
          "items": {
            "$ref": "#/$defs/StepDefinition"
          },
          "type": "array"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Workflow-level cleanup",
      "title": "Finally"
    },
    "on_complete": {
      "anyOf": [
        {
          "items": {
            "$ref": "#/$defs/StepDefinition"
          },
          "type": "array"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Steps to run on successful completion",
      "title": "On Complete"
    },
    "on_failure": {
      "anyOf": [
        {
          "items": {
            "$ref": "#/$defs/StepDefinition"
          },
          "type": "array"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Steps to run on workflow failure",
      "title": "On Failure"
    },
    "guardrails": {
      "anyOf": [
        {
          "$ref": "#/$defs/GuardrailsConfig"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Default guardrails applied to all steps"
    },
    "llm": {
      "anyOf": [
        {
          "$ref": "#/$defs/LLMDefaultsConfig"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Default LLM configuration for all actions"
    },
    "shell_safety": {
      "$ref": "#/$defs/ShellSafetyMode",
      "default": "strict",
      "description": "Shell injection prevention mode"
    },
    "workspace": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Working directory for the workflow",
      "title": "Workspace"
    },
    "secrets_dir": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Directory containing secret files",
      "title": "Secrets Dir"
    },
    "default_timeout": {
      "default": 300,
      "description": "Default step timeout in seconds",
      "minimum": 1,
      "title": "Default Timeout",
      "type": "integer"
    },
    "max_parallel": {
      "default": 1,
      "description": "Maximum parallel step execution (future)",
      "minimum": 1,
      "title": "Max Parallel",
      "type": "integer"
    }
  },
  "required": [
    "name",
    "jobs"
  ],
  "title": "WorkflowDefinition",
  "type": "object"
}
